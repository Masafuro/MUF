# MUF (Multi-Unit Framework) プロトコル仕様書（ヘッダーレス・イベント駆動版）

## 1. 概要
MUFプロトコルは、Redisのキー空間（Namespace）を階層的なパス構造として活用し、ユニット間通信、状態管理、およびデータの自浄作用（GC）を統合した軽量メッセージングプロトコルである。データ本体（Value）に制御用メタデータ（ヘッダー）を持たせず、すべてのステータス情報をキーパスに集約することで、高い視認性とRedis標準機能との親和性を実現する。

## 2. キー空間設計（Namespace Hierarchy）
全てのデータは、以下の4階層で構成される一意なキーによって識別される。
形式：`MUF/[UNITNAME]/[STATUS]/[ID]`

### 2.1 階層の定義
1. **第1層 (ROOT)**: `MUF` 固定文字列。プロトコルのルートを識別する。
2. **第2層 (UNITNAME)**: 通信の発行元、またはデータの所有者となるユニットの一意な名称。
3. **第3層 (STATUS)**: データの現在のフェーズまたは属性を示す。
   - `REQ`: リクエスト（依頼）状態。
   - `RES`: レスポンス（正常完了）状態。
   - `ERR`: エラー（異常終了）状態。
   - `KEEP`: 永続的または長期間保持される状態。
4. **第4層 (ID)**: メッセージまたはセッションの一意な識別子。発行元ユニット内で重複しないことが保証される必要がある。

## 3. データ形式（Data Payload）
データ本体（Value）はメタデータを含まない。形式はUTF-8文字列、JSON、バイナリデータ等、利用するユニット間で合意された任意の形式（FreeString）とする。SDKは読み取ったバイナリをそのまま、あるいは指定されたデコード形式でユーザープログラムへ渡す。

## 4. 有効期限（TTL）と自浄ルール
MUFはRedisの `EXPIRE` 機能を通信のタイムアウト管理およびメモリの自動解放に利用する。

### 4.1 デフォルトTTL設定
SDKは各動作に対して以下のデフォルト値を保持するが、これらは初期化時および実行時に上書き可能である。
- **REQ (Request)**: 10秒（バックエンドが処理を開始するまでの猶予）。
- **RES/ERR (Response)**: 30秒（フロントエンドが結果を回収するまでの猶予）。
- **KEEP (State)**: 86,400秒（24時間。状態保持用）。

### 4.2 ライフサイクル管理
データの明示的な削除（DEL）は原則として行わない。処理の完了またはタイムアウトにより、TTLが経過した時点でRedisによって物理的に消去されることを正味のクリーンアップとする。

## 5. 通信シーケンス

### 5.1 リクエスト・レスポンス（RPC型）
1. **フロントエンド**: `MUF/[FRONTEND]/REQ/[ID]` にデータを `SET ... EX [TTL]` する。同時に `MUF/[FRONTEND]/RES/[ID]` および `MUF/[FRONTEND]/ERR/[ID]` の生成を Keyspace Notifications で監視する。
2. **バックエンド**: `__keyspace@0__:MUF/*/REQ/*` を監視（PSUBSCRIBE）し、キー生成の通知（set）を受け取った瞬間にリクエストを読み取る。
3. **バックエンド**: 処理完了後、結果を `MUF/[FRONTEND]/RES/[ID]`（成功時）または `MUF/[FRONTEND]/ERR/[ID]`（失敗時）に `SET ... EX [TTL]` する。
4. **フロントエンド**: 通知を受けてデータを読み取り、ユーザーに返却する。

### 5.2 タイムアウト処理
フロントエンドが設定したタイムアウト時間（通常はREQ/RESのTTLに準拠）内にレスポンスキーが現れない場合、SDKは通知の漏れまたは相手ユニットの停止と判断し、待機を解除してエラーを返す。

## 6. 実装上の要件
- **非同期処理**: SDKはKeyspace Notificationsの監視を非同期（asyncio等）で行い、複数リクエストの同時待機を可能にする必要がある。
- **引数による柔軟性**: 全ての通信メソッドはオプション引数として `ttl` を受け取り、デフォルト設定を個別に上書きできる必要がある。
- **視認性の維持**: キー名には極力、人間が判読可能な文字列を使用し、デバッグの容易性を保つこと。