# MUF: Memory Unit Framework

## プロジェクトの概要と設計思想

MUF（Memory Unit Framework）は、分散システムにおけるユニット間連携を、Redis上の階層化されたキー空間の状態変化として再定義するフレームワークです。本フレームワークは、産業用コントローラの共有メモリ概念をネットワーク空間へ拡張し、各ユニットが特定の階層構造に従ってデータを配置することで、疎結合かつ自律的な連携を実現します。

最大の特徴は、RedisのKeyspace Notificationsを利用したリアクティブなイベント駆動モデルと、すべてのデータに設定されるTTL（有効期限）による自動的なメモリ清掃機能にあります。本バージョンでは、DB上のパスをすべて小文字のプレフィックス（muf/）に強制正規化する仕様を採用しており、開発者が大文字小文字の差異に起因する不整合に悩まされることなく、堅牢な非同期メッセージングを記述できる環境を提供します。

---

## 通信ステータスとパス仕様

MUFプロトコルでは、すべてのデータは `muf/[unit]/[status]/[id]` という小文字の階層構造を持ち、それぞれの役割と有効期限が以下のように定義されています。SDKを介した入力は、内部で自動的に小文字へ正規化されます。

| ステータス名 | 役割の定義 | デフォルト有効期限(TTL) |
| :--- | :--- | :--- |
| **req** | 特定の処理を依頼するリクエスト。送信側ユニットのディレクトリ配下に生成されます。 | 10秒 |
| **res** | リクエストに対する成功応答。リクエスト送信側のresディレクトリに書き戻されます。 | 60秒 |
| **err** | 処理中に発生した例外やエラーの通知。resと同様のパスに書き戻されます。 | 60秒 |
| **keep** | システム全体で共有する状態データ。長期間の保持を目的とした共有メモリです。 | 3600秒 |

---

## 開発環境の運用手順

ルートディレクトリに配置された `docker-compose.yml` を司令塔として、システムの起動と観測を行います。各ユニットの設定は `include` 機能により統合管理されており、ディレクトリを移動することなく操作が可能です。

### 1. 通信基盤の起動
システムの神経網であるRedisをバックグラウンドで常駐させます。これにより、すべてのユニットが通信可能な共有空間が生成されます。
> docker compose up -d muf-redis

### 2. メモリ空間の観測
共有メモリ上でのデータの生成、更新、およびTTLによる消滅をリアルタイムで監視するためのモニターを起動します。このモニターはMUFプロトコルを解釈し、整形されたログを出力します。
> docker compose run --rm muf-monitor

### 3. 対話型操作と介入
人間がシステムにリクエストを投げ込んだり、応答をシミュレートしたりする場合は、ターミナルユニットを使用します。入力されたパスは大文字が含まれていても、SDKによって自動的に小文字へ正規化されてRedisへ書き込まれます。
> docker compose run --rm muf-terminal

---

## ディレクトリ構成と各コンポーネントの責務

プロジェクトはルートディレクトリからの相対パスで各機能が分離されており、開発者は必要な道具をルートから直接呼び出すことができます。

| ディレクトリ | 構成要素 | 責務の詳細 |
| :--- | :--- | :--- |
| **muf/** | MUF SDK | パスの小文字強制正規化、接続管理、非同期監視を担う共通コアライブラリです。 |
| **monitor/** | 観測ユニット | muf/* の通知を解釈し、人間が読みやすい形式でメモリ遷移を可視化する専用ツールです。 |
| **terminal/** | 操作ユニット | ユーザーが直接コマンドを打ち込み、共有メモリの状態を書き換えるためのHMIです。 |
| **redis/** | インフラ構成 | 物理的なRedisサーバーの設定と、キー空間通知（KEA）の有効化設定を保持します。 |

---

## 現在の進捗と開発フロー

現在はSDKのコアロジックが「小文字絶対主義」に基づいて刷新され、ターミナルでの入力がモニターによって確実に捕捉・解析される段階にあります。特にモニターユニットが expired イベントを検知してメモリの自動清掃を明示できるようになったことで、データのライフサイクルが視覚的に保証されるようになりました。ルートディレクトリでの include 構成への移行により、各ユニットの管理が一本化され、迅速な開発サイクルが実現しています。