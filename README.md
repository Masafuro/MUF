# MUF: Memory Unit Framework

## プロジェクトの概要と設計思想

MUF（Memory Unit Framework）は、分散システムにおけるユニット間連携を、Redis上の階層化されたキー空間の状態変化として再定義するフレームワークです。本フレームワークは、産業用コントローラの共有メモリ概念をネットワーク空間へ拡張し、各ユニットが特定の階層構造に従ってデータを配置することで、疎結合かつ自律的な連携を実現します。

最大の特徴は、RedisのKeyspace Notificationsを利用したリアクティブなイベント駆動モデルと、すべてのデータに設定されるTTL（有効期限）による自動的なメモリ清掃機能にあります。本バージョンでは、DB上のパスをすべて小文字のプレフィックス（muf/）に強制正規化する「小文字絶対主義」を採用しており、大文字小文字の差異に起因する不整合を物理的に排除した、極めて堅牢な非同期メッセージング環境を提供します。

---

## 通信ステータスとパス仕様

MUFプロトコルにおいて、すべてのデータは muf/[unit_name]/[status]/[id] という小文字の階層構造を持ちます。SDKを介した入力は内部で自動的に正規化され、それぞれのステータスに応じた役割と有効期限が適用されます。

| ステータス名 | 役割の定義 | デフォルト有効期限(TTL) |
| :--- | :--- | :--- |
| **req** | 特定の処理を依頼するリクエスト。送信側ユニットの空間に生成されます。 | 10秒 |
| **res** | リクエストに対する成功応答。リクエスト送信側の空間に書き戻されます。 | 60秒 |
| **err** | 処理中の例外やエラー通知。resと同様のパスに書き戻されます。 | 60秒 |
| **keep** | 共有状態データ。長期間の保持を目的とした定常的な共有メモリです。 | 3600秒 |

具体的な実装方法やコードサンプルについては、以下のドキュメントを参照してください。
[MUF ユニット開発リファレンス (v2.0)](doc/unit_reference_v2.md)

---

## 開発環境の運用手順

ルートディレクトリに配置された docker-compose.yml を司令塔として、システムの起動と観測を行います。各ユニットの設定は include 機能により統合管理されています。

### 1. 通信基盤とバックエンドの起動
システムの神経網であるRedisと、自動応答を担うエコーユニットをバックグラウンドで起動します。
docker compose up -d muf-redis muf-echo-unit

### 2. メモリ空間のリアルタイム観測
共有メモリ上でのデータの生成、更新、およびTTLによる消滅を監視するためのモニターを起動します。
docker compose run --rm muf-monitor

### 3. 対話型操作によるシステム介入
人間がシステムにリクエストを投げ込んだり、応答を確認したりする場合は、ターミナルユニットを使用します。
docker compose run --rm muf-terminal

---

## ディレクトリ構成と各コンポーネントの責備

プロジェクトはルートディレクトリからの相対パスで各機能が分離されており、開発者は必要な道具をルートから直接呼び出すことができます。

| ディレクトリ | 構成要素 | 責務の詳細 |
| :--- | :--- | :--- |
| **muf/** | MUF SDK | 接続管理、パスの正規化、fnmatchによるワイルドカード監視を担うコアライブラリです。 |
| **monitor/** | 観測ユニット | キー空間通知を解釈し、メモリ遷移を人間が読みやすい形式で可視化するツールです。 |
| **terminal/** | 操作ユニット | ユーザーが直接コマンドを打ち込み、リクエスト発行や状態操作を行うためのHMIです。 |
| **echo-unit/** | 実装サンプル | すべてのリクエストに対して自動的にエコー応答を返す、バックエンドの標準実装です。 |
| **doc/** | ドキュメント | プロトコル仕様書やユニット開発リファレンスなどの設計資産を保持します。 |

---

## 現在の進捗と開発フロー

現在は、SDKの内部構造を「イベント監視（Watcher）」と「メッセージ配送（Dispatcher）」に分離する大規模なリファクタリングが完了しています。これにより、ワイルドカードを用いた柔軟なリクエスト監視が極めて安定して動作するようになりました。実際に muf-terminal から発行されたリクエストに対し、muf-echo-unit が即座に反応してレスポンスを書き戻す一連の通信サイクルが実証されています。今後は、この堅牢な基盤の上に、より複雑な計算ロジックを持つユニットや、外部APIと連携するゲートウェイユニットを追加し、MUFエコシステムの更なる拡大を進めていく予定です。